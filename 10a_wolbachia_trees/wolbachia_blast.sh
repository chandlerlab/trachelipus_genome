#!/bin/bash
#PBS -k o 
#PBS -l nodes=1:ppn=4,vmem=16gb,walltime=4:00:00
#PBS -M cholden23@gmail.com
#PBS -m abe 
#PBS -N check_wolbachia
#PBS -j oe 

#####################################################
#####################################################

REF=/N/dc2/scratch/chrichan/trachelipus_assembly/final_cov/trachelipus_v1_unmasked_plus_malespecific.fasta

cd /N/dc2/scratch/chrichan/trachelipus_assembly/
cd wolbachia_trees

cat ncbi-genomes-2019-08-08/*.fna > all_wolbachia_genomes.fasta

makeblastdb -in all_wolbachia_genomes.fasta -dbtype nucl

#BLAST all the assembled Trachelipus contigs against set of reference Wolbachia genomes

blastn -task blastn \
       -num_threads 4 \
       -query ${REF} \
       -db all_wolbachia_genomes.fasta \
       -evalue 1e-6 \
       -outfmt '6 qseqid sseqid evalue bitscore length pident qstart qend sstart send' \
       -out all_wolbachia_blast.txt
      
#Merge all the matching candidate Wolbachia regions
cat all_wolbachia_blast.txt | awk '{if ($3 <= 1e-10) {print $0}}' | sort -k 1,1 -k 7n,7n > all_wolbachia_blast_sorted.txt
cat all_wolbachia_blast_sorted.txt | awk '{print $1 "\t" $7 "\t" $8}' > all_wolbachia_blast_sorted.bed
module load bedtools/gnu/2.26.0
bedtools merge -d 50 -i all_wolbachia_blast_sorted.bed > all_wolbachia_candidates_merged.bed

#extract the matching Trachelipus sequences
bedtools getfasta -fo candidate_wolbachia_sequences.fasta -fi ${REF} -bed all_wolbachia_candidates_merged.bed

#get representative bacterial genomes excluding wolbachia from RefSeq
wget ftp://ftp.ncbi.nlm.nih.gov/genomes/refseq/bacteria/assembly_summary.txt
cat assembly_summary.txt | awk -F "\t" '{if (($12=="Complete Genome") && ($11=="latest") && ($5=="representative genome")) {print $0}}' | grep -v -i "wolbachia" | awk -F "\t" '{print $20}' > ftpdirpaths.txt
awk 'BEGIN{FS=OFS="/";filesuffix="genomic.fna.gz"}{ftpdir=$0;asm=$10;file=asm"_"filesuffix;print ftpdir,file}' ftpdirpaths.txt > ftpfilepaths.txt
mkdir -p representative_bacteria
cd representative_bacteria
while read X
do
  wget ${X}
done < ../ftpfilepaths.txt
gunzip *.fna.gz
cd ..
cat representative_bacteria/*.fna > representative_bacteria.fasta
#add the trachelipus mitochondrial genome so we can remove mitochondrial hits too...
echo '>KR013001.1 Trachelipus rathkei mitochondrion, partial genome' >> representative_bacteria.fasta
echo 'AGTTTTCTCGTCAAAATCGTGGCCATAACTGGCTAGTTTCTTGGTTAAATTACCTAAGGTTTTAAATATTTATAACCTTAGGTAATTTAACCAAGAAACTAGCCAGTTATGGCCACGATTTTGACGAGAAAACTACGAATATCCCCCGACTTTCCCTTTTTTGTTGGGGTCGGGGTATTCGTATATTTACTCATAATATTTGGTTAAAACCATAATTTTTTCGAATATGAAAAGGGTCCTGGTTTATTTAATCAAGGTTTTACGAAGTTATCTGGTCTCAAGTTTTAGATAATATAGGCTCAATTATAAAGAACCTAAAATATATAATTGTTAGAATTTGGCCTGTAATAATATAAGGGGCTTCTACTGGTTTAGCCCCGATCCATGTTAACAAAGAGGCGACAGAAAAGAAAGATCACAAAAGCAACTGATTTACAGGGTAAAATTGAAGGGATTGAATTTTTTTTTTTGATGAGAAAGGAAGAGTATAAAGAACTATAATAGATAATACTAAAGCAATTACACCTCCTAATTTATTAGGAATGGAACGTAAGATAGCGTAGGCAAATAGATAATATCACTCTGGTTGAATATGAGGGGGAGAGTTTAAAGGGTTAGCCAGGTTAAAATTTTCCGGGTCTCCTAATATATAAGGGTTTCATAAGCACATAGAGGTTAGTACTAAAATAAATAATAATACTCCGATAATGTCTTTCATTGTAAAATAAGGATGGAGAGTTAATTTAAGAGAGTTTCTTTTTAACCCCAAGGGATTACTAGAGCCTGTTTGATGAAGGAATATAATATGTAAGGCTGCTATAGCAAAAATTACATAAGGGAGAAGAAAATGTAGGGTGAAGAATCGTGTTAAAGTAGGGGTTCTTACTGCGAATCCCCCCCACAACCATTGAACTAGGTTTGTTCCTATATAAGGGATTGTTGATAATAGGTTTGTAATTACAGAAGCCCCTCATAAAGATATCTGTCCTCAAGGGAGAACATACCCTAAAAAGGCTGTAGCTATTGTTAGAAATAAAATAGAGGTTCCTAATATTCAGGTATGGGTAAGGGTATAAGAACTGTAATACATACCTCGTCCAATATGGAGGTAAAGACAAATAAAGAATATAGAGGCTCCGTTAGCGTGAAATGTTCGAATTAGCCAACCATTGTTTACATCCCGGCAGATATAAGTAATATTATCAAAAGCTAAATCTACATGTCCTGAGTAATGCATAGCCAAGAATATACCGGTGATAATCTGTAATATTAAACACAAACCTAATAAGGAGCCAAAATTTCACCAGAAAGAAATATTTAAGGGGGAAGGCATGTCAATTAGAGTAGAGTTTAAAATTTTTATTAAAGGGTTTATTTTGCGATGGTTTAAATGAATTAAAAGATTTCTATATTACAAAAATAGTGTTTTAAATATAAACTATAGTGAATATTTTTTTTAGAAAAGGAAAATGTATGGATAATACTTATAATAATAGTTTTTATATTATTGTCTATAATTTTTGGCCTAGATTTAATAGTTTCAGGTAAAAGTTATGTTTTAGAGTGGGGAATTTTAAGAAGAGGAAGGGTAAGAATACTATTTAATTTTTATATTGATTGAATATCTGTTATTTTTTTTGGTTTTATTGCACTAATTTCAAGCTCAATTTTTTTTTATAGTGGTAGTTATATAAAAGCTAGTTTGAATTTTCGTTTATTTATGATATTAGTTTTTATATTTGTGGTTAGGATATTTTTTTTAGTTTTTAGTTTAAACTTAGTAAGGATAATATTAGGGTGGGATGGACTAGGGGTGACTTCTTATATTCTAGTTATCTTCTATAAAAATGAGAAATCCGGGAGAGCGGGGATAGTAACAGCTTTAAGAAATCGTGTAGGAGACGCGGCTTTATTATTAAGTATTGCTTGTTTAGTTGAATTAGGGAGATGGAGATACATATTTATATTAATAAATAAAGGTGAGTTAGTTATATGGTTGGTGAGGTTAGCTGCTATTACTAAAAGAGCTCAAATTCCATTTTCTGCTTGGCTACCAGCAGCAATAGCAGCTCCAACTCCTGTAAGGGCTTTAGTACATTCCTCTACTTTGGTAACAGCTGGGGTCTATTTATTGATTCGTTTTGAAAGATTATTAATAGGCTCTAAAATTATGAATTTTTTAATTTATTTAGGTTTAATAACTACTCTTATAGCAAGATTAAGAGCTTTAGTAGAGGTTGATTTTAAAAAGGTAGTCGCTTTATCTACTTTAAGCCAGCTGGGTATTATAGTTAGAACTTTATCAATAGGGTTTTCACAGTTAGCTTTTGTCCATTTACTTATCCATGCAGTGTTTAAAGCTTTATTATTTATATGTAGAGGAAAAATTATTCATAGAATAAATGACTCTCAAGATATTCGTAAGATGGGGGGGATAATTTTTAACCTTCCTATTACTGGAATAGTTATAAATTTATCAAGTTTAGCCTTATGCGGAGTACCCTTTTTATCAGGATTTTATTCTAAAGATTTAATTATTGAATCTATAATGATAACGGATAACTTTTTAATATTCTATAGATTTTTAATAATAGTAGTAGGGCTATCAGCTAGATACTCGTTTCGATTAATATTTTTGAGATTTAATATTTTTTCAAATCAAGCTTTAGTAAGTTCTAGAGAAGAGAAAGATTGAGTAATATTAAGATCTAAGATTGGGTTAATAACTATATCTTTGATTAGAGGGGCTATTTTACTTTGGGTGGTAATACCAATTCCTGTTATAGTGAGGCTTTCTATAAATTTAAAATGGTTAGCTTTTGTGAGAATGATCTTAGGGGTTTTTATTGGTTTAATATGAAGAGTAAGGAACCTAAAAAGACTAGTATTAATAAAAGGTTTAGCCCAAGTTGACATATATTTACTAATATGAAATATATCTAAATTGAGAGGTAATAAATTAAGACACACAGGCCAGTCTATCAGTCTATTAATTAAAAAAATAGATTTTGGGTGATCAGAAGCTTTTGGGGGACAGGGTTTAAATTTCTTTTTCTTAAAAAGAAGGGAGGTATTAAGTTTATGATTAATTAATAGGTTAAAAAAAAATCTACTTGTGATAATTATAATATTAGTTGTTATCATAACGAATATTTGATAAAGAAGTTTTTAGAACATAATACTGAAGATATTAAAGAGGTTACATTCTCATTTTTAAGACCACAACTTAATATTTTAATAAATTATTAACTTACAAATAAATTTGTAATAGCCAAGGAGCTAAAAATAAAAGATTTAAAGGAACCCAATGTAAGGTTAAAATTAATCACTCTCGTAAGGAGGGGGGGTAGAAAGGTTTTAAAAGAGAGGGGGTTTTACCGTGTTGTGTTTGCCTAAATAGAAAAAGGGAATAGCAAGCAGATATGAAAACTAATATCCTTAAAATTAAGGCTAATCTTAAATTTCAAGAAAAAATGGATGTAATCCTATTTATTTCTCCCAAAAGGTTTAAAGTAGGAGGAGCCGCTATATTAGATGTACAAAGGAGGAATCATATTATAGCTAGTGAAGGGGAAAGGGATTGAAGCCCTTTTAATAAAAACAATCTACGGGAGTTAGTCCGTTCGTAAATTATATTAGCAATACAAAATAATCCTGAGGAGCAAAATCCATGCCCAATTATAATAAATTGAGCCCCATTAATACCTCAAGATGAAAAGGTTAACGCACCTGCTATTACTAAAGATATATGAGCAACAGAAGATAAAGCAATTAAAAATTTAATGTCCCTTTGGAATAAACAAACTAGAGATACAAGGACTCCTCCTGAAAGAGACCAGCTCAATATAAAAGGGCTGATGTTATAAAATATATGTTCTATACCATTAGAAAATCGAAAGATACCATACCCTCCTAATTTCAAAAGAATAGCAGCTAGAATTATAGAACCAGCCACAGGGGCTTCAACATGAGCTTTAGGGAGTCATAAATGGATCAGGTATAGAGGAAGTTTAACCGAAAAGGCAAAAATAAGGGCAAATGATATAAGGTTTGAAATAATATGATTTCTAGGATAAAGAAATACAATTAAGAGGTTAGATGTTTTTGTTGAGTCAACTCAAATTAAAATACCAATTAGTAAAGGAAGGGAAGCAAAAACTATATAAATTAATAAATACACCCCGGCTTGCACACGTTCAGGTTGGTTTCCTCAACCTAAAATTAATATAAAGGTGGGGATCAGAGAGGCTTCAAATAAGGTATAAAATAAAATTAAATTTACAGTTCTGAAGGTTAAAATTAAAATTAATGATAATGAAATTAAAACTATGATAAAGGTTTTTTTGTACCTAATAATATTTCTATTTGAAACACTTGCCAAGGTTCTTAAAGCCATAATTAAAATAGTTAGATTAATTAATGAAAAAGAAAGAGAATCTAAAAATAATAGTTTATGAAGTAAAAAAATATCTTGATAATGTCTTAAGAAAAAAGCTATAATAGTTAATATAATTAATAACAAGCTAATAAAAGAATACAAAGTAAAAGGCAGAGTCAAAGATATTATTAATAAAATACAAATTTTTATCATTATAATGGTTTAATTATTTCATTTCCTTTCTTAAGGGTGTAAAGAATAACAATACTGAGCCCTAAAGCTGCTTCGCACACCGCAATTGAGATATATATAAAGCAATAAAATGTTTCATAAGGAAATGAAAAGGAGATTAAGGAGATTTTTAGATAAATAATTAATGTTATACACTCCAAACAAATTAACGAAGATAGTAAATGTTTGAATACAAAAACAAAAGTCAATATAGAAAGAAAAAATATGTAGTTAGATGTTAAAAAAGATATCTGTAATATAATAGTTAAATTTTAGTATCCAAAACTAATGTTTTATTTAAACTAATTTCTGAAATAATGTTTTTTATAATAGCTTGTATAGCACTATCCTGCTTAATAATTTTAGTAGAAGGCCCTCAAATTTTAGTCGCTTTTCTAGTTTTATTATCATTTATTATAGTTATTTTTTTAAGGTTAATAGTGAGAGTTTGATACTCTTATATTTTATTTTTAGTATTTTTAGGAGGAATATTAGTGGTTTTTGTATATGTAAGAGGACTAGCTCCTTCAGTTAAAACTAATTATAATTACGAAAATTATTTAAAAATTGCAAGGTGTTTAATCGTAGTAGTATTTTTTTTAAAAATAGACAGAGGGTCAATAGTTCTTTTTAAGGCAGATAGATTTTCGGTAGGGAGTGAGGGGTCTGTTTATCTCTTGATATCTAATAGTAGATATAAATTATATTTATTTGTTGTAGGCTATTTGTTGTTAACTTTAAGATGCGTATGTGGATTAGTAAAGAGATATGAAGGTCCTTTAAAAAAATTTTAATAAAAGGTAGCTAAACTAAAGTAGATGTTTTGAAAACATCCGATAGATAATTTAACGAAAGTTTATTAAAAATTATTATTTAAAAGTCCTTACGTACTAGATAAATACAAGTTTACTAGAAGATAGAATCCAACCTGGCTCACGCCGGTTTGAACTCAAATCATGTGATAAATTAAAGGTCGAACAGACCTACGAATTTCTAGGGCTGCTTAGAAAAGTAATATCAATTCAACATCGAGGTCATAATCTTTTATGTCGATAAGTAACTCTATATAAAAATTATGCTGTTATCCCTAAAGTACCTTTTTGGGTTTAATTTAAGTTGAGTATACCCATTCATTTTGTTATATTAAATTATGAGATATAATTTGCCTCCCCAGCAAAAAGAGTAACACTCTTAAAAGGTTTTAGGGTCTTATCGTCTATCTAAGGTAGATAAACTTTTTTATTTACTTATTAATTTCAAAAAACAAGAAGAAAATTATTCTTTCGTCAGACCCTTCATTCCAGTGGTCAATTAAACAACTAATTATTATGCTACCTTAGCACAGTCATGATACTGCGGCTTTTAATCATCAGTGAGCAGGTCCTACCTTGAATGGTAAATAAAAGAGTTGTTTTTGTTAAACAGGCGAAGAAACAAATAGTCTAGTTTTTGCTAGTTGGACTTAGATTTAAAATAACATTTAAATTCAATAATAAAAAATTTTTACTAATAGACCTATTATTAAATTTTAAATTAATTAGAAAAGCTTAGGTAATAAGAATTTATATTGGTTGGAGGTTAGAATATGAAACGCCTGTTTAAATAATAATATTAATTCTTTTAAAGGTTTTAGGTTTCCTAAAATTTATTCAATAGAAGATCATTTTTTAAAAAGTGTAATTTAATTATTTAAAAGCTAGCTGGATATAAGGATAATGTTAAAATATCTTTTCTAGAAGTATATAACTAAATAGACTGAAACCTAGATATGAGATACAAATAGCTCTATCCTTTTCAAGGTATAATACCAAATATAGGTTAAGTCCCCCTGATACTAAAGGTATAAAATTATTAATTAGTTTATTTTATTTCCCTTGAGGTAAATAACACAATTCTAAAAATAATTATTGGATAACACAATAAATTAAAGGAGGACTTTTAAGTTCAAAACCTAACGTGCAATTAACACTTAAAAAATATTCAAAAATTATTTAAAATAAGATAAATAATAATTTAAGATAAGCTAAAAAAGCTAGTGGGTTCATACCCCATTGATGGTTTGACCTCTGAATTATGCTTAGAACACCTTTTAGGTTTTTTTTTGTGGCAGGTATATTAGTAGGGATTTGAATTACAATTTATAGAAGAAGATGGGTGGGGGTTTGAATAGGATTAGAAATAAACTTAATATGTTTTATCCCTTTTTTAGTTAAAGGAAAGACAGGGGGAATGGCTTGTATTTTTTATTTTTTAGCTCAAGCTACTGGGTCTCTTTTACTTTTAATTAGGGGGTTAGATATTTGAAGTTATGATCTTACGTTAAAGCTTTATATAAGGGTGGGGTTATTACTCAAAGCCGGAGTGGCTCCTTTCCATTTTTGATACCCTGTAGTAGCTTCTCAAATTAAATGGTCTGAGTTCGTTGTTTTAAGAACCTTACAAAAAATTGCCCCTTTATCTTTGTTATACCATTGTGATTTGTTTATGTTAGGGCAATTTATATATTTAACTATCATTATAAGAGGGGTAGTGGGGGCATTAGGGGGATTAAATGAGTTAAAAGTACGAGGTGTTTTGATTTATTCTTCTATTAATCATATAGGATGGGTGATAATACCTTTGATTAATCATAGCATGAGTTGGGCAGTTTATTTTAGAATATATTGCATAATACTAACTTCAGTTGTAGTATTAGTTTACTTTTACAGGATTTATAATTTAACACAGCTTTATAGACCGGAAACCCCATTTTGGCATGGTTTTGTTTTTGGAGTTGGGTTATTTTCTTTAGGAGGGGTGCCTCCTTTTTTAGGATTTTTCGTTAAATGTTGATTACTTTATTTGGTTGGTCCATTTATGGATCCTTTCGCGTTAATGGTCCTTATTTTTATAAGATCAATTACACTATTCTACTATATTACATTAGGAATCCCTCATCTGATTTTTGTTTGAGAAAATCCATTAATTCAACAACGTTTTATTGATTTAATAGTTGTTAGTTTTGTGCTTTTTACTAGGATCCTAGGATTATGAATTATACCGGCTTTTGTTATCTGGTTTATATAATCAGGCTTTTACAATAAATTGTGAACTCAGGTTTGCAGCTTGAGGATTTTTAAACCTAACTCTTCTACAGGTTTACAACCTATCGCTTTATAGCTTTTACAATATGCAACGCTGATTTTATTCCACAAATCATAAAGATATTGGGACATTGTATTTTGTATTTGGTGCTTGAGCAGGGGCTGTTGGAACAGCCCTTAGGATAATTATTCGAACTGAGTTAGGAAACCCTGGGAGGTTAATTGGAGACGATCAGATTTATAATGTGATTGTTACTGCTCATGCTTTTGTAATAATTTTTTTTATAGTTATACCTATTATAATTGGAGGCTTTGGTAATTGATTAGTACCTTTAATATTAGGGGCCCCTGATATAGCTTTTCCGCGTATAAATAATATAAGATTTTGGCTTCTTCCCCCATCACTAATTTTGTTATTAAGAAGAGGTTTAGTTGAAAGAGGTGTTGGGACTGGCTGGACTGTCTACCCACCTTTGGCAAGTGGAATTGCCCATAGAGGGGCTTCAGTAGATTTAGGGATTTTTTCCCTTCATTTGGCTGGAGCTTCTTCAATTTTAGGAGCTGTAAATTTTATTACTACTGTAATTAATATACGAGCAGAGGGGATAAGGATAGATCGTGTCCCTCTATTTGTTTGGTCAGTGTTAATTACAGCAATTCTCTTGTTACTTTCACTACCAGTTTTAGCAGGGGCCATTACTATGTTATTAACAGACCGTAATCTGAACACCTCTTTTTTCGACCCTAGGGGGGGAGGAGATCCTATCTTGTACCAACACTTATTTTGATTTTTCGGACATCCTGAGGTTTATATTTTAATTTTACCCGCATTTGGGATAATTTCTCATATTGTTAGACAGGAGTCTAATAAAAAAGAAGCTTTTGGTACTTTAGGGATAATTTATGCGATAATTGCTATTGGTGTATTAGGGTTTGTTGTATGAGCTCATCATATATTTACAGTAGGGATAGATGTTGATACTCGTGCTTATTTTACTTCAGCTACTATAATTATTGCTGTCCCTACTGGTATTAAGATTTTTAGTTGGCTGAGAACTTTACATGGGGCTCATTTAAGGTTTAGACCCGCTCTATTATGGGCTTTAGGTTTTATTTTTTTATTTACATTAGGGGGGTTAACAGGGGTAATCCTAGCTAATTCATCTATTGATATCATTTTACATGATACTTATTATGTAGTAGCCCATTTCCATTATGTTTTATCTATAGGGGCAGTATTTGCTATTTTTGGGGGGGTGGTACATTGGTTTCCTTTATTTACTGGGTTAAGGATAAGGAGCTTTTGATTAAAGGTTCAATTTCTGGTAATGTTTATTGGAGTAAATCTCACATTTTTCCCTCAACATTTCTTAGGGTTGGGAGGAATACCGCGTCGTTATTCTGACTACCCGGATGTTTATAGGTTTTGAAATCTAGTATCGTCTATTGGGTCTTTGCTTTCTGTTGTTTCTGTAATAATATTTTTGTTGATTATTTGAGAGGCTCTTTTAGCAGAGCGTTATTATATAGCTCTGGAAAGGTTAAGATCCTCTTTAGAGTGATTCCACCCCAACCCACCTGCGGATCATAGGTATGATGAAATTCCTATAAGAACTTTTTAACTCTAAGCAGCAATTGAGTGTAAAGGAGTTAGAATCCTTAAAAGGTAGAGACCTTAAAAGATACCTTGGTGAAGGAGGTTTGGTTTGCAAGATAGGGTTTCTCCTTTAATAAGGCAGCTGATCTTTTTTCATGATCATACCATAATTATTATTACTTTAATTATCAGAGTAGTTGGTTATATTATGTTAAGGATGGTGGTGGGGGGTTTTGTTAACCGGTCCTTATTGGAGAGCCAATTAATTGAAATAATTTGAACTGTTTTACCTGCGTTAATTTTACTATTTATTGCTCTCCCCTCCCTACACCTTCTTTATCTGCTGGATGAGGTAAGAACGCCTAGGTTAACGATCAAGGTTATTGGGCACCAGTGGTATTGAAGATATGAATATTCGGATTTTAAGGCTATAGAGTTTGATGCATACATAATACCTGAAAAAGAATTGAGAGAAGGTGGTTTCCGTGTATTAGAGGTAGACCATCGGACTGTTGTGCCGTTTTTAACACAGATCCGTGTCCTGGCCTCAGCTTCTGATGTAATCCATTCTTGGACTGTCCCTAGACTAGGGGTAAAAGTTGATGCTGTGCCAGGACGGTTAAACCAACTAAGGTTTTTGACTGAACGCACGGGTGTATTGTACGGGCAGTGTTCTGAGATTTGTGGAGCTAACCACAGATTTATACCTATTGTTTTAGAAGTGGTTTTGTTAAAACCATTCTTATCTTGGTTAGAAGGTTCACAAGTTGGCTGAGGGTAGGCGGGAGGTTTTTATTCTTCTTACAAAAAGTTAGTTTAATTAAATAATATAAGGTTGTCAATCTTAAGTTTAAGCATATCCCTCAGATAAGTCCACTTCCTTGGGTAAGGTTATTAATAGTGGTTTTAGGTCTTACAATAATATATATAATTTTAGTTTATTTCTCAGTTAGCAAGAGTTTAAATAGGAAAAATATCAAGGTTAATAAGTTAAGATATTCATGAAAATGATAACAAATCTATTCTCAGTATTTGACCCTTCTTCAGGGGTTGGTATAAGCTTTAATTGGGTTTCTTTTGGAGTTGGGTTTTTTATATTCCCTATAAATAAATGAGGGCTTACTTCACGGAGGGGGAGTTGGTTAACTTTTATTTTAGGAAAGTTATATTCTGAGGTAAAACCTATTTTTTCAATCAAAGGCAGGGTTACCTCCCTTATATTTATAGCTATATTCTTATTTATTATTATAAATAATATAATAGGACTTATTCCTTACATTTTTACGGCTACAAGCCATCTGGCGGTGACATTGAGATTAGCTCTGCCTATATGATTAGGGTATTTTAGCTATGGTTGGGTTAGAAATATAAAATGAATATTGGCTCACTTAATACCCCAAGGTACCCCTATTGTCCTTATACCTTTTATAGTGATTATTGAGAGCGTAAGAAGGTTGATTCGCCCCGCTACATTGGCTGTACGGTTAATAGCTAATATGATTGCAGGGCATCTTTTACTCACCCTTGTGAGCAATGCGGTGTATATTTTTAATTTTAATAGGGTATTAAGGGTAGTAACTTTACAGATTTTATTAGTAGTGTTGGAGGTGGCTGTAGCTGCCATTCAGGCGTATGTCTTTGTAGTCTTAAGAGTCTTATATTCAAGAGAGATTTAAATGATAAACTTTAACCATCACCCTTTCCATCTTGTTAATCCTAGACCTTGGCCACTTACCAGCTCATTAGGGGCTTTTTTACTCACTAGGGGGTTAGTAAAATGGTTTAACTTTTTTTCTATAGATCTTCTTCTAGTGGGAGGGGTAAGGGTACTATTATCTATAGTACAATGATGACGGGATGTAGTGCGGGAGGGTACTTTCCAAGGTCTTCATACTATAAAAGTTCAAAAAGGGCTTCAATGGGGTATACTTTTGTTTATTATCTCTGAGGTCTTATTTTTTTTTTCTTTCTTTTGAGCTTTTTTCCATAGTAGGTTAAGCCCTAGAATAGAGCTAGGTAGAGTATGACCTCCTGAGGGGGTTACTCCTTTTAACCCATTTAATATCCCATTACTGAATACCGTTATCTTATTAAGGTCGGGGGCTACCGTAACATGAGCTCACCACAGGTTACTACACCGAGAGCATTCAGAGGCAGTTAATAGCTTATTATTAACAGGTCTTCTTGGGATTTACTTTACTAGCCTACAAGCATTTGAGTATGTGGAGGCCTCTTTTTCTATTTCGGACTCAGTGTATGGGGCTACTTTTTTTGTAGCCACTGGTTTTCATGGTCTTCATGTAATTATTGGGACTACTTTTCTATTAGTATGTCTAGGACGGATAGTGGGGGGCCATTTTTCTGCAACCCATCATTTTGGGTTTGAGGCGGCCGCCTGGTATTGACATTTTGTAGATGTAGTATGGTTATTTTTATATATTTCTATTTACTGATGAGGGACTTTCCTCTATAGTATAAGGAGTACAGTTGGTTTCGAACCAAAAAGTCTGTAGGAGGTAAAATTTTTAATTTTTAGAAGGGTTGCTATTCTGGTTATTTCTACCACCCTTCTTCTTTTATCCCCTCTATTAGGAAATAAGCAGAATTCAAATTTTGAAAAAGGGACACCTTTTGAGTGTGGGTTTGACCCCTTAGGGAGGGGTCAGTTAAATTTTTCAATCCGGTTCTTTTTGATTGCTGTTGTTTTTATAATTTTTGATGTGGAGATTGCATTATTATTACCACTAGTAGTGACTACCTTAAGGGGGAATTATATGATTTGAGTCTTTAATAGGGTGGTATTCCTATTAGTTTTAACCTTAGGTACTTTCTTTGAATGGAAGGAGGGGGCTCTGGAGTGGAAGTAGTTAAACTATAGTTTATAAAAACAGGTGATTTACATTCAGAAGAAGAGATAGGGTTAGGTAGTTTTTAAGACAAAGAAAAAAAGAAGGGCCCTAATAGAGATTGGGAGAAAAATTTTCCAAGCAAGGGCTATTAATTTATCATACCGAAGGCGGGGGAGAGTGGCTCGAACCCAGATAAAAGTAAAAGCTAAGAGTAGGGTTCAGAGTGTGAGAAGGGAGTTCAAGTCATTTGGGTTAAGAAAAAGAACTCTAAAGAGAAAGCTTATAAATAAAATCCTTCTATACTCAGCTAGAAAGAACAGGACAAAACCCCTTGCCGCATATTCGGTGTTAAATCCTGATACAAGTTCAGACTCCCCCTCTGAAAAATCAAAAGGGGTTCGGTTGGTTTCTGCTATAGCAGAGGTCAGCCATAAGATAGCTAAGATAGGGCTGATCCTTAGGATAGGGAAGGTAAAACTAAATAAAAATGAAAAAGTATTAAAAGAGGAGGAGAGCGCCACCAATCTGAGGGTAATAATAGCAAACCTAACCTCATAGGAGATAGTCTGAGCTACAGCCCGTAAACTCCCTAGCATAGCATATTTAGAGTTAGAGGCCCAACCCGCCCTCAAGGTGGGGTAGACCCTAGCAGAGAGGCAGCATAAGACAAAGATAATAGAAAGGTGAACCTCTATTCTACCTAAAGTGGAAGGGAAGGATAACCATAAGAGTATAGAGACAAGTAAAACCCTACAAGGCCTTATAAAATAGACCAGCTGGTGAGGGGAGTTTAAAACTAAAGTTTCTTTAGAGAGGAGTTTAATGGCGTCACTGAAAGGTTGAAGAACTCCCTTAAACCCTAACTTATTAGGCCCTTTACGTTTTTGAATATATCTTAAAGATTTACGTTCAAGAAGAGTGAAGAAAGCCACCCTTAACAAAATACAAATAAACAGAATTGTTAATTTTATTAGATTGTAAAAGATAAACATTTAGAGAGTAAAGCCAAAATCAAGAGGCGGGCCTCTGTTACAGGCTATAGTGGAAGGTTTCCTATCTTATAAGGTTTTACCTTAGCCTATTGGTTAAGTAAAAGTGTCCTATATGGGATCTTAAGAGTAGATAAAGTTAGAGTAAAAGAAATTGCCCTCACTCCTCCCCAATAGTTAAATTTGGAATCTGGTTAATTTCCTGGGCCAGCACCCTCCCGATGAAGTCAGTGCCAGCAGTCGCGGTTAGACTGAAGGGGTTTAACTGTATTTGAAAGATAGGTGGTAATTTTAACCTTTAAAAAAGAGGTGAAATTTTTATTTTGAAAGGTTCCCCTAGTAAGCCTTTGAAATTTAAAAGATAAACAAGGATTAGATACCCTTCTATATTTAAATGAAAATTCTTAAGGAGAGTAGTTGTTATAGTCTTGAAACCCAAAAGGTATGGCGGTATTTAGTTAAATCAGAGGAACCTGCCCAATAAGTGATACCCCTCATTATATCTTACCTTTTTTAGGTTTGTATACCGTCGTCTAAGCTATATTTATAAATCTAAGAGCTAGAAGCAGAGATGGGTAATTCAGATCCAGGCGCAGCTTTAAAAGGTTGAGGTGGGTTACATTTAAACTTTTAATGGAAAGAGGAGGAAATGTACCTGAAAATTGGATTTGAAAGTAATTTAAATTTAATAAGTTTAAATGAGTGTTTTTCTAAATATGTACATATCGCCCGTCACTCTCAGTCAATGAGATAAGTCGTAACAAAGTAGATGTACTGGAAAGTACCTCTTTAGTTTGGAAATTGAGGATGATGCTCTCAAATAGTAGATTCTACCCAACCTTAATATTTAAGTTAGAAAAACTACTATCCTTCAAAGATAGCCTCCATGTAATAACAGGTAGTGTATCAGCATGCTACTTTTTCATAGTGGAAGAAGTGAGGCAGGGGAACCGGTACAGGAGTTTCTAACTCTAATATTTAATATTAGAGTTAGAAACTCCT' >> representative_bacteria.fasta

#add the wolbachia reference genomes, but rename contigs first so they are easily recognized as wolbachia later
cat all_wolbachia_genomes.fasta | awk '{if ($0 ~ ">") {print $1 "_wolbachia"} else {print $0}}' > all_wolbachia_genomes_renamed.fasta
cat representative_bacteria.fasta all_wolbachia_genomes_renamed.fasta > representative_bacteria_plus_wolbachia.fasta

#BLAST against the full reference set (representative bacteria + wolbachia)
makeblastdb -in representative_bacteria_plus_wolbachia.fasta -dbtype nucl
#filter out low-complexity regions -- for some reason, in initial attempts
#  we still got lots of ATATATATATATATATATATATA hits in blast searches
dustmasker -in candidate_wolbachia_sequences.fasta -outfmt fasta -out candidate_wolbachia_sequences_softmasked.fasta
cat candidate_wolbachia_sequences_softmasked.fasta | awk '{if ($1 ~ ">") {print $0} else {gsub(/a/, "N"); gsub(/c/, "N"); gsub(/g/, "N"); gsub(/t/, "N"); print $0}}' > candidate_wolbachia_sequences_hardmasked.fasta

blastn -task blastn \
       -num_threads 4 \
       -query candidate_wolbachia_sequences_hardmasked.fasta \
       -dust yes \
       -db representative_bacteria_plus_wolbachia.fasta \
       -evalue 1e-6 \
       -max_target_seqs 20 \
       -outfmt '6 qseqid sseqid evalue bitscore length pident qstart qend sstart send' \
       -out candidate_representative_blast.txt

#now identify regions that are likely true hits against Wolbachia
# either only match wolbachia, or best non-wolbachia hit is worse (1000-fold difference in e-values)

#add a dummy line to the end of the blast hits so that the last record doesn't get ignored in processing
cp candidate_representative_blast.txt candidate_representative_blast_dummy.txt
echo -e x"\t"x"\t"1"\t"1"\t"1"\t"1"\t"1"\t"1"\t"1"\t"1 >> candidate_representative_blast_dummy.txt

echo 'import sys' > process_blast_hits.py
echo 'blast_hits_file = sys.argv[1]' >> process_blast_hits.py
echo 'blast_hits_handle = open(blast_hits_file, "r")' >> process_blast_hits.py
echo 'best_wo_score = 1.0' >> process_blast_hits.py
echo 'best_non_score = 1.0' >> process_blast_hits.py
echo 'best_wo_line = "X"' >> process_blast_hits.py
echo 'last_query = "X"' >> process_blast_hits.py
echo 'for cur_line in blast_hits_handle:' >> process_blast_hits.py
echo '  cur_fields = cur_line.strip().split("\t")' >> process_blast_hits.py
echo '  cur_score = float(cur_fields[2])' >> process_blast_hits.py
echo '  if (cur_fields[0] == last_query):' >> process_blast_hits.py
echo '    if ("wolbachia" in cur_fields[1]):' >> process_blast_hits.py
echo '      if (cur_score < best_wo_score):' >> process_blast_hits.py
echo '        best_wo_score = cur_score' >> process_blast_hits.py
echo '        best_wo_line = cur_line.strip()' >> process_blast_hits.py
echo '    else:' >> process_blast_hits.py
echo '      if (cur_score < best_non_score):' >> process_blast_hits.py
echo '        best_non_score = cur_score' >> process_blast_hits.py
echo '  else:' >> process_blast_hits.py
echo '    if (best_wo_score < (best_non_score/1000)):' >> process_blast_hits.py
echo '      print best_wo_line' >> process_blast_hits.py
echo '    best_wo_score = 1.0' >> process_blast_hits.py
echo '    best_non_score = 1.0' >> process_blast_hits.py
echo '    best_wo_line = "X"' >> process_blast_hits.py
echo '    if ("wolbachia" in cur_fields[1]):' >> process_blast_hits.py
echo '      best_wo_score = cur_score' >> process_blast_hits.py
echo '      best_wo_line = cur_line.strip()' >> process_blast_hits.py
echo '    else:' >> process_blast_hits.py
echo '      best_non_score = cur_score' >> process_blast_hits.py
echo '  last_query = cur_fields[0]' >> process_blast_hits.py
echo 'blast_hits_handle.close()' >> process_blast_hits.py


python process_blast_hits.py candidate_representative_blast_dummy.txt > wolbachia_hits_filtered.txt

sort -k 4nr,4nr wolbachia_hits_filtered.txt > wolbachia_hits_filtered_sorted.txt